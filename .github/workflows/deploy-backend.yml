# .github/workflows/deploy-backend.yml

name: Deploy TableTap-OrderProcessing Lambda

# This workflow triggers on any push to the 'main' branch.
on:
  push:
    branches:
      - feature/take-stripe-integration

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # These permissions are required for the OIDC integration to work.
    permissions:
      id-token: write
      contents: read

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Python environment
      # Using a stable version supported by AWS Lambda
      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      # Step 3: Install dependencies into a './dist' folder
      # This reads your new requirements.txt file.
      - name: Install dependencies
        run: |
          pip install -r lambda-function/requirements.txt -t ./dist

      # Step 4: Prepare deployment package by copying all source files
      # This copies both your lambda_function.py and emailtemplate.html
      - name: Prepare deployment package
        run: |
          cp lambda-function/* ./lambda/

      # Step 5: Configure AWS credentials using your GitHub Secret
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_FOR_OIDC_ARN }}
          aws-region: ca-central-1 # Your AWS region

      # Step 6: Deploy the OrderProcessor Lambda Function
      # The 'dist' directory now contains your code, template, and dependencies.
      - name: Deploy OrderProcessor Lambda
        uses: aws-actions/aws-lambda-deploy@v1
        with:
          function-name: TableTap-OrderProcessing
          code-artifacts-dir: ./lambda/
          runtime: python3.13